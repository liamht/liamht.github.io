document.getElementById('stats-container').style.display = 'grid';
            document.getElementById('stat-blunder').innerText = stats.blunders;
            document.getElementById('stat-great').innerText = stats.great;
            document.getElementById('stat-book').innerText = stats.book;
        } catch (e) { log(`Analysis Error: ${e.message}`, true); }
        stopAnalysis();
    }

    async function analyzeGame(game, user, onMove) {
        const chess = new Chess();
        chess.load_pgn(game.pgn);
        const history = chess.history({verbose: true});
        const isWhite = game.white.username.toLowerCase() === user.toLowerCase();
        const openingMatch = identifyOpeningByNotation(history.map(h => h.san));
        
        let moveData = [];
        let counters = { blunders: 0, great: 0, book: 0 };
        const tempChess = new Chess();

        for (let i = 0; i < history.length; i++) {
            if (!isScanning) return null;
            onMove(i + 1, history.length);

            const isUserTurn = (isWhite && i % 2 === 0) || (!isWhite && i % 2 !== 0);
            const isBook = i < openingMatch.count;
            
            const fenBefore = tempChess.fen();
            tempChess.move(history[i]);
            const fenAfter = tempChess.fen();

            const best = await getEngineAnalysis(fenBefore, !isUserTurn);
            const actual = await getEngineAnalysis(fenAfter, true);

            const getV = (d) => d.isMate ? (d.score > 0 ? 10000 : -10000) : d.score;
            const diff = (i % 2 === 0) ? getV(best) - getV(actual) : getV(actual) - getV(best);
            const cls = classifyMove(diff, isUserTurn, isBook);

            if (isUserTurn) {
                if (cls.label === 'Blunder') counters.blunders++;
                if (['Best', 'Excellent'].includes(cls.label)) counters.great++;
                if (isBook) counters.book++;
            }

            moveData.push({ 
                san: history[i].san, from: history[i].from, to: history[i].to,
                eval: actual.score, isMate: actual.isMate,
                fen: fenAfter, classification: cls, openingName: isBook ? openingMatch.name : null,
                moveNum: Math.floor(i/2) + 1, turn: i % 2 === 0 ? 'w' : 'b',
                bestEngineMove: best.bestMove
            });
        }

        return { 
            moves: moveData, isWhite, opponent: isWhite ? game.black.username : game.white.username, 
            result: (isWhite ? game.white.result : game.black.result) === 'win' ? 'WIN' : 'LOSS', 
            blunders: counters.blunders, greatMoves: counters.great, bookCount: counters.book, openingName: openingMatch.name
        };
    }

    function renderGameItem(game, analysis) {
        const list = document.getElementById('game-list-view');
        const card = document.createElement('div');
        card.className = "stat-card";
        card.style.cursor = "pointer";
        card.onclick = () => openReview(analysis);
        card.innerHTML = `
            <div style="text-align:left">
                <div style="font-weight:bold">vs ${analysis.opponent}</div>
                <div style="color:var(--primary); font-size:11px; margin-bottom:5px">${analysis.openingName}</div>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span style="font-size:11px; color:var(--subtext)">${analysis.moves.length} moves</span>
                    <span style="font-weight:bold; color:${analysis.result === 'WIN' ? 'var(--success)' : 'var(--accent)'}">${analysis.result}</span>
                </div>
            </div>
        `;
        list.appendChild(card);
    }

    function openReview(analysis) {
        currentReviewGame = analysis;
        document.getElementById('game-list-view').style.display = 'none';
        document.getElementById('review-view').style.display = 'grid';
        const listUi = document.getElementById('moves-tab');
        const graphUi = document.getElementById('eval-graph');
        listUi.innerHTML = ''; graphUi.innerHTML = '';

        analysis.moves.forEach((m, idx) => {
            const row = document.createElement('div');
            row.className = 'move-row';
            row.id = `move-${idx}`;
            row.onclick = () => goToMove(idx);
            row.innerHTML = `<span style="color:#666; width:30px">${m.moveNum}${m.turn==='w'?'.':''}</span><b style="width:50px">${m.san}</b><span class="move-label ${m.classification.class}">${m.classification.label}</span>`;
            listUi.appendChild(row);

            const bar = document.createElement('div');
            bar.className = 'graph-bar';
            const v = currentReviewGame.isWhite ? m.eval : -m.eval;
            bar.style.height = `${Math.min(100, Math.max(5, 50 + (v / 20)))}%`;
            bar.onclick = () => goToMove(idx);
            graphUi.appendChild(bar);
        });
        goToMove(0);
    }

    function goToMove(idx) {
        currentMoveIndex = idx;
        const m = currentReviewGame.moves[idx];
        renderBoard(m.fen, m);
        updateMoveCard(m);
        document.querySelectorAll('.move-row').forEach(r => r.classList.remove('active'));
        document.getElementById(`move-${idx}`)?.classList.add('active');
    }

    function updateMoveCard(m) {
        document.getElementById('move-opening').innerText = m.openingName || "";
        document.getElementById('move-title').innerText = `${m.moveNum}${m.turn==='w'?'.':''} ${m.san}`;
        document.getElementById('move-desc').innerText = m.classification.desc;
        document.getElementById('move-badge').innerHTML = `<span class="move-label ${m.classification.class}">${m.classification.label}</span>`;
        
        const playerRelativeEval = currentReviewGame.isWhite ? m.eval : -m.eval;
        const fillPercent = Math.min(100, Math.max(0, 50 + (playerRelativeEval / 20)));
        document.getElementById('eval-fill').style.width = `${fillPercent}%`;
        
        if (m.isMate) {
            const prefix = playerRelativeEval > 0 ? "+" : "-";
            document.getElementById('eval-label').innerText = `M${prefix}${Math.abs(m.eval)}`;
        } else {
            const displayScore = (playerRelativeEval / 100).toFixed(1);
            document.getElementById('eval-label').innerText = (playerRelativeEval > 0 ? "+" : "") + displayScore;
        }
    }

    function renderBoard(fen, move) {
        const board = document.getElementById('active-board');
        board.innerHTML = '';
        const chess = new Chess(fen);
        const pos = chess.board();
        const flip = !currentReviewGame.isWhite;

        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const ar = flip ? 7-r : r, ac = flip ? 7-c : c;
                const sq = document.createElement('div');
                const sqId = String.fromCharCode(97+ac) + (8-ar);
                sq.className = `square ${(ar+ac)%2===0?'white':'black'}`;
                if (sqId === move.from || sqId === move.to) sq.classList.add('highlight');
                const p = pos[ar][ac];
                if (p) {
                    const img = document.createElement('img');
                    img.className = 'piece';
                    img.src = `https://lichess1.org/assets/piece/cburnett/${p.color}${p.type.toUpperCase()}.svg`;
                    sq.appendChild(img);
                }
                board.appendChild(sq);
            }
        }

        const arrow = document.getElementById('best-move-arrow');
        if (move.bestEngineMove && move.classification.label !== 'Best' && move.classification.label !== 'Book') {
            const fromSq = move.bestEngineMove.substring(0, 2);
            const toSq = move.bestEngineMove.substring(2, 4);
            
            const getCoords = (sq) => {
                const col = sq.charCodeAt(0) - 97;
                const row = 8 - parseInt(sq[1]);
                const fx = flip ? 7 - col : col;
                const fy = flip ? 7 - row : row;
                return { x: fx * 12.5 + 6.25, y: fy * 12.5 + 6.25 };
            };

            const start = getCoords(fromSq);
            const end = getCoords(toSq);
            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const angle = Math.atan2(dy, dx);
            const offset = 2.5; 
            
            arrow.setAttribute('x1', start.x);
            arrow.setAttribute('y1', start.y);
            arrow.setAttribute('x2', end.x - Math.cos(angle) * offset);
            arrow.setAttribute('y2', end.y - Math.sin(angle) * offset);
            arrow.setAttribute('display', 'block');
        } else {
            arrow.setAttribute('display', 'none');
        }
    }

    function stepMove(d) {
        const next = currentMoveIndex + d;
        if (next >= 0 && next < currentReviewGame.moves.length) goToMove(next);
    }

    function switchTab(t, el) {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('moves-tab').style.display = t === 'moves' ? 'block' : 'none';
        document.getElementById('graph-tab').style.display = t === 'graph' ? 'block' : 'none';
    }

    function exitReview() {
        document.getElementById('game-list-view').style.display = 'grid';
        document.getElementById('review-view').style.display = 'none';
    }

    function stopAnalysis() {
        isScanning = false;
        document.getElementById('btnScan').style.display = 'block';
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('progress-box').style.display = 'none';
    }

    window.onload = initApp;
</script>
</body>
</html>
