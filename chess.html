<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess User Reviewer</title>
    <style>
        :root {
            --bg-dark: #0f0f0f;
            --card-bg: #1a1a1a;
            --primary: #3498db;
            --accent: #e74c3c;
            --warning: #f39c12;
            --success: #2ecc71;
            --excellent: #27ae60;
            --book: #a29bfe;
            --text: #f5f5f5;
            --subtext: #888;
            --border: #2a2a2a;
            --board-white: #ebecd0;
            --board-black: #779556;
            --highlight: rgba(255, 255, 0, 0.4);
            --active-row: #2c3e50;
        }
        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-dark); color: var(--text); 
            margin: 0; overflow-x: hidden;
        }
        .container { max-width: 1200px; margin: auto; padding: 20px; }

        /* Navigation / Search */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .controls { background: var(--card-bg); padding: 15px; border-radius: 12px; display: flex; gap: 10px; border: 1px solid var(--border); flex: 1; margin-right: 20px;}
        input { flex: 1; padding: 12px; border-radius: 6px; border: 1px solid #333; background: #000; color: #fff; }
        button { padding: 12px 24px; border-radius: 6px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: bold; }
        #btnStop { background: var(--accent); display: none; }

        /* Stats Section */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 22px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 11px; color: var(--subtext); text-transform: uppercase; margin-top: 5px; }

        /* Game List */
        #game-list-view { display: block; }
        .game-item { 
            background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border); 
            margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; transition: transform 0.1s;
        }
        .game-item:hover { border-color: var(--primary); transform: translateY(-2px); }
        .game-info { flex: 1; }
        .game-result { font-weight: 800; min-width: 60px; text-align: right; }

        /* Review Mode View */
        #review-view { display: none; grid-template-columns: 1fr 400px; gap: 30px; }
        .back-btn { margin-bottom: 15px; background: #333; width: fit-content; padding: 8px 15px; }

        /* Board Area */
        .board-container { width: 100%; max-width: 500px; margin: 0 auto; }
        .board-wrapper { position: relative; aspect-ratio: 1/1; background: #222; border: 4px solid #333; border-radius: 4px; overflow: hidden; }
        .chess-board { display: grid; grid-template-columns: repeat(8, 12.5%); grid-template-rows: repeat(8, 12.5%); width: 100%; height: 100%; }
        .square { position: relative; display: flex; align-items: center; justify-content: center; }
        .square.white { background: var(--board-white); }
        .square.black { background: var(--board-black); }
        .square.highlight { background-color: var(--highlight) !important; }
        .piece { width: 90%; height: 90%; pointer-events: none; z-index: 2; }
        
        /* Classification Icon on Board */
        .move-type-icon { 
            position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; 
            z-index: 5; border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; font-size: 10px; font-weight: bold; color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .arrow-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* Labels */
        .board-layout-outer { display: grid; grid-template-columns: 30px 1fr; grid-template-rows: 1fr 30px; }
        .labels-y { display: flex; flex-direction: column; justify-content: space-around; align-items: center; font-size: 12px; color: var(--subtext); }
        .labels-x { grid-column: 2; display: flex; justify-content: space-around; align-items: center; font-size: 12px; color: var(--subtext); }

        /* Probability / Eval */
        .eval-bar-container { width: 100%; height: 24px; background: #000; border-radius: 12px; margin-top: 15px; position: relative; overflow: hidden; border: 1px solid #444; }
        .eval-bar-fill { height: 100%; background: #fff; width: 50%; transition: width 0.4s ease-out; }
        .eval-text { position: absolute; width: 100%; height: 100%; top: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; mix-blend-mode: difference; color: white; }

        /* Move Detail Card */
        .move-detail-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            margin-top: 15px; 
            padding: 12px; 
            display: flex; 
            align-items: center; 
            gap: 15px;
        }
        .move-detail-icon-wrap { 
            width: 48px; height: 48px; background: #222; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center;
        }
        .move-detail-icon-wrap img { width: 80%; height: 80%; }
        .move-detail-info { flex: 1; }
        .move-detail-title { font-weight: bold; font-size: 16px; margin-bottom: 2px; }
        .move-detail-sub { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--subtext); }
        .move-rating-tag { font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        /* Tabs and Side Panel */
        .side-panel { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; height: 600px; }
        .tab-headers { display: flex; background: #111; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; color: var(--subtext); cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--card-bg); }
        .tab-content { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* Moves List */
        .move-list-scroll { height: 100%; overflow-y: auto; position: relative; }
        .move-row { display: grid; grid-template-columns: 40px 1fr 60px; padding: 10px; border-bottom: 1px solid #222; cursor: pointer; }
        .move-row.active { background: var(--active-row); }
        .move-num { color: #555; font-family: monospace; }
        .move-san { font-weight: bold; }
        .move-eval { text-align: right; font-family: monospace; font-size: 12px; }
        .badge { font-size: 9px; padding: 2px 5px; border-radius: 4px; text-transform: uppercase; margin-left: 5px; }

        /* Breakdown Styles */
        .opening-box { padding: 12px; background: #222; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
        .opening-name { font-weight: bold; color: var(--primary); }
        .opening-stats { font-size: 12px; color: var(--subtext); margin-top: 2px; }

        .breakdown-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .breakdown-table th { text-align: left; color: var(--subtext); font-weight: normal; padding-bottom: 8px; border-bottom: 1px solid #333; }
        .breakdown-table td { padding: 8px 0; border-bottom: 1px solid #222; }
        .type-col { display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .mini-icon { width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; color: white; }
        .val-col { text-align: center; font-weight: bold; }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .nav-btn { flex: 1; padding: 12px; background: #333; color: white; border-radius: 6px; border: none; cursor: pointer; }
        
        #progress-box { display: none; margin-bottom: 20px; background: #111; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        .progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; margin-top: 10px; }
        .progress-fill { width: 0%; height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s; }

        @media (max-width: 900px) {
            #review-view { grid-template-columns: 1fr; }
            .side-panel { height: 400px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-bar">
        <div class="controls">
            <input type="text" id="username" placeholder="Enter Chess.com Username" onkeyup="if(event.key==='Enter') startAnalysis()">
            <button id="btnScan" onclick="startAnalysis()" disabled>Loading...</button>
            <button id="btnStop" onclick="stopAnalysis()">Stop</button>
        </div>
    </div>

    <div id="progress-box">
        <div id="progress-text" style="font-size: 12px; color: var(--subtext)">Initializing...</div>
        <div class="progress-bg"><div id="progress-fill" class="progress-fill"></div></div>
    </div>

    <div id="game-list-view">
        <div id="stats-container" class="stats-grid" style="display:none">
            <div class="stat-card"><div id="stat-winrate" class="stat-val">0%</div><div class="stat-label">Win Rate</div></div>
            <div class="stat-card"><div id="stat-blunder" class="stat-val">0</div><div class="stat-label">Total Blunders</div></div>
            <div class="stat-card"><div id="stat-great" class="stat-val">0</div><div class="stat-label">Great Moves</div></div>
            <div class="stat-card"><div id="stat-opening" class="stat-val">-</div><div class="stat-label">Fav Opening</div></div>
        </div>
        <div id="ui-game-list"></div>
    </div>

    <div id="review-view">
        <div class="review-main">
            <button class="nav-btn back-btn" onclick="exitReview()">← Back to List</button>
            
            <div class="board-container">
                <div class="board-layout-outer">
                    <div class="labels-y"><div>8</div><div>7</div><div>6</div><div>5</div><div>4</div><div>3</div><div>2</div><div>1</div></div>
                    <div class="board-wrapper">
                        <div id="active-board" class="chess-board"></div>
                        <svg id="active-arrows" class="arrow-overlay" viewBox="0 0 100 100"></svg>
                    </div>
                    <div class="labels-x"><div>a</div><div>b</div><div>c</div><div>d</div><div>e</div><div>f</div><div>g</div><div>h</div></div>
                </div>

                <div class="eval-bar-container">
                    <div id="eval-fill" class="eval-bar-fill"></div>
                    <div id="eval-label" class="eval-text">0.0</div>
                </div>

                <div id="move-detail" class="move-detail-card">
                    <div class="move-detail-icon-wrap">
                        <img id="detail-piece-img" src="" alt="">
                    </div>
                    <div class="move-detail-info">
                        <div id="detail-name" class="move-detail-title">Loading...</div>
                        <div class="move-detail-sub">
                            <span id="detail-best">Best move: -</span>
                            <span id="detail-rating" class="move-rating-tag">Rating: -</span>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="nav-btn" onclick="stepMove(-1)">Previous</button>
                    <button class="nav-btn" onclick="stepMove(1)">Next</button>
                </div>
            </div>
        </div>

        <div class="side-panel">
            <div class="tab-headers">
                <button id="tab-btn-overview" class="tab-btn active" onclick="setTab('overview')">Breakdown</button>
                <button id="tab-btn-moves" class="tab-btn" onclick="setTab('moves')">Moves</button>
            </div>
            
            <div id="tab-overview" class="tab-content">
                <div id="view-opening-box" class="opening-box">
                    <div class="opening-label" style="font-size:10px; text-transform:uppercase; color:var(--subtext)">Opening Phase</div>
                    <div id="view-opening-name" class="opening-name">-</div>
                    <div id="view-opening-stats" class="opening-stats">0/0 book moves played</div>
                </div>

                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Classification</th>
                            <th style="text-align:center">You</th>
                            <th style="text-align:center">Them</th>
                        </tr>
                    </thead>
                    <tbody id="breakdown-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                
                <div style="margin-top:20px; padding-top:15px; border-top:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                        <span style="color:var(--subtext)">Opponent</span>
                        <span id="view-opponent" style="font-weight:bold">-</span>
                    </div>
                    <div style="display:flex; justify-content:space-between">
                        <span style="color:var(--subtext)">Result</span>
                        <span id="view-result" style="font-weight:bold">-</span>
                    </div>
                </div>
            </div>

            <div id="tab-moves" class="tab-content" style="display:none; padding:0">
                <div id="move-list-container" class="move-list-scroll"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
const STOCKFISH_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
let engine = null;
let isScanning = false;
let activeGame = null;
let currentMoveIdx = 0;

const CLASSIFICATIONS = [
    { name: 'Great', key: 'Great', color: '#2ecc71', icon: '★' },
    { name: 'Best', key: 'Best', color: '#27ae60', icon: '✔' },
    { name: 'Good', key: 'Good', color: '#3498db', icon: '·' },
    { name: 'Inaccuracy', key: 'Inaccuracy', color: '#f1c40f', icon: '?!' },
    { name: 'Mistake', key: 'Mistake', color: '#e67e22', icon: '?' },
    { name: 'Blunder', key: 'Blunder', color: '#e74c3c', icon: '??' }
];

const PIECES = {
    'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
    'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
    'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
    'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
    'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
    'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg',
    'P': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
    'R': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
    'N': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
    'B': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
    'Q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
    'K': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
};

const PIECE_NAMES = {
    'p': 'Pawn', 'r': 'Rook', 'n': 'Knight', 'b': 'Bishop', 'q': 'Queen', 'k': 'King'
};

async function bootEngine() {
    try {
        const response = await fetch(STOCKFISH_CDN);
        const scriptBody = await response.text();
        const blob = new Blob([scriptBody], { type: 'application/javascript' });
        engine = new Worker(URL.createObjectURL(blob));
        engine.onmessage = (e) => {
            if (e.data === 'uciok') {
                document.getElementById('btnScan').disabled = false;
                document.getElementById('btnScan').innerText = "Review Profile";
            }
        };
        engine.postMessage('uci');
    } catch (e) { console.error("Engine failed", e); }
}

function getEngineAnalysis(fen) {
    return new Promise((resolve) => {
        let score = 0, isMate = false, bestMove = '';
        const timeout = setTimeout(() => resolve({ score: 0, isMate: false, bestMove: '' }), 10000);
        const handler = (e) => {
            if (e.data.includes('score cp')) {
                const m = e.data.match(/score cp (-?\d+)/);
                if (m) score = parseInt(m[1]);
            } else if (e.data.includes('score mate')) {
                const m = e.data.match(/score mate (-?\d+)/);
                if (m) { score = parseInt(m[1]); isMate = true; }
            }
            if (e.data.startsWith('bestmove')) {
                clearTimeout(timeout);
                const m = e.data.match(/bestmove\s+(\S+)/);
                bestMove = m ? m[1] : '';
                engine.removeEventListener('message', handler);
                resolve({ score, isMate, bestMove });
            }
        };
        engine.addEventListener('message', handler);
        engine.postMessage(`position fen ${fen}`);
        engine.postMessage('go depth 12');
    });
}

function getStorageKey(user) { return `chess_v2_${user.toLowerCase()}`; }

async function startAnalysis() {
    const user = document.getElementById('username').value.trim();
    if (!user) return;
    
    isScanning = true;
    document.getElementById('btnScan').disabled = true;
    document.getElementById('btnStop').style.display = 'inline-block';
    document.getElementById('progress-box').style.display = 'block';

    const cached = JSON.parse(localStorage.getItem(getStorageKey(user)) || "[]");
    renderList(cached);
    updateGlobalStats(cached);

    try {
        const archivesRes = await fetch(`https://api.chess.com/pub/player/${user}/games/archives`);
        const archivesData = await archivesRes.json();
        const archives = archivesData.archives.reverse();
        const processedUrls = new Set(cached.map(g => g.url));
        
        for (let arcUrl of archives) {
            if (!isScanning) break;
            const gamesRes = await fetch(arcUrl);
            const gamesData = await gamesRes.json();
            const games = gamesData.games.reverse();
            
            for (let g of games) {
                if (!isScanning) break;
                if (processedUrls.has(g.url)) continue;

                const chess = new Chess();
                if (!g.pgn) continue;
                chess.load_pgn(g.pgn);
                const history = chess.history({ verbose: true });
                const isWhite = g.white.username.toLowerCase() === user.toLowerCase();
                
                let opening = "Standard Opening";
                const pgnMatch = g.pgn.match(/\[Opening "(.*?)"\]/);
                if (pgnMatch) opening = pgnMatch[1];

                const gameData = {
                    url: g.url, 
                    opponent: isWhite ? g.black.username : g.white.username,
                    isWhite, 
                    result: (isWhite ? g.white.result : g.black.result) === 'win' ? 'Win' : 'Loss',
                    opening,
                    moves: [], 
                    blunders: 0, 
                    great: 0, 
                    date: new Date().getTime()
                };

                const temp = new Chess();
                for (let i = 0; i < history.length; i++) {
                    if (!isScanning) break;
                    const fenBefore = temp.fen();
                    const evalBefore = await getEngineAnalysis(fenBefore);
                    const move = history[i];
                    temp.move(move.san);
                    const fenAfter = temp.fen();
                    const evalAfter = await getEngineAnalysis(fenAfter);

                    const val = (d) => d.isMate ? (d.score > 0 ? 10000 : -10000) : d.score;
                    const loss = (i % 2 === 0) ? val(evalBefore) - val(evalAfter) : val(evalAfter) - val(evalBefore);
                    
                    let label = 'Good';
                    if (loss > 300) label = 'Blunder';
                    else if (loss > 150) label = 'Mistake';
                    else if (loss > 80) label = 'Inaccuracy';
                    else if (loss < 10) label = 'Best';
                    
                    if (loss < -10) label = 'Great';

                    const isUserMove = (isWhite && i % 2 === 0) || (!isWhite && i % 2 !== 0);
                    if (isUserMove) {
                        if (label === 'Blunder') gameData.blunders++;
                        if (label === 'Great') gameData.great++;
                    }

                    gameData.moves.push({
                        san: move.san, from: move.from, to: move.to, piece: move.piece, color: move.color,
                        fen: fenAfter, score: evalAfter.score, isMate: evalAfter.isMate,
                        best: evalBefore.bestMove, label, isUser: isUserMove
                    });

                    document.getElementById('progress-text').innerText = `Analyzing vs ${gameData.opponent} (${i+1}/${history.length})`;
                    document.getElementById('progress-fill').style.width = `${((i+1)/history.length)*100}%`;
                }

                if (isScanning) {
                    cached.unshift(gameData);
                    localStorage.setItem(getStorageKey(user), JSON.stringify(cached));
                    renderList(cached);
                    updateGlobalStats(cached);
                }
            }
        }
    } catch (e) { console.error(e); }
    finally {
        isScanning = false;
        document.getElementById('btnScan').disabled = false;
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('progress-box').style.display = 'none';
    }
}

function updateGlobalStats(games) {
    if (!games.length) return;
    const wins = games.filter(g => g.result === 'Win').length;
    const blunders = games.reduce((acc, g) => acc + g.blunders, 0);
    const great = games.reduce((acc, g) => acc + g.great, 0);
    
    document.getElementById('stats-container').style.display = 'grid';
    document.getElementById('stat-winrate').innerText = `${Math.round((wins/games.length)*100)}%`;
    document.getElementById('stat-blunder').innerText = blunders;
    document.getElementById('stat-great').innerText = great;
    
    const openings = {};
    games.forEach(g => {
        if (g.opening) openings[g.opening] = (openings[g.opening] || 0) + 1;
    });
    const fav = Object.entries(openings).sort((a,b) => b[1]-a[1])[0];
    document.getElementById('stat-opening').innerText = fav ? fav[0].split(':').pop().trim() : '-';
}

function renderList(games) {
    const cont = document.getElementById('ui-game-list');
    cont.innerHTML = games.map((g, idx) => `
        <div class="game-item" onclick="enterReview(${idx})">
            <div class="game-info">
                <div style="font-weight:bold">vs ${g.opponent}</div>
                <div style="font-size:12px; color:var(--subtext)">${g.opening ? g.opening.split(':')[0] : 'Game'} • ${g.moves.length} moves</div>
            </div>
            <div class="game-result" style="color:${g.result === 'Win' ? 'var(--success)' : 'var(--accent)'}">
                ${g.result.toUpperCase()}
            </div>
        </div>
    `).join('');
}

function enterReview(idx) {
    const user = document.getElementById('username').value.trim();
    const games = JSON.parse(localStorage.getItem(getStorageKey(user)));
    activeGame = games[idx];
    currentMoveIdx = 0;

    document.getElementById('game-list-view').style.display = 'none';
    document.getElementById('review-view').style.display = 'grid';

    const breakdownBody = document.getElementById('breakdown-body');
    breakdownBody.innerHTML = CLASSIFICATIONS.map(c => {
        const userCount = activeGame.moves.filter(m => m.isUser && m.label === c.key).length;
        const oppCount = activeGame.moves.filter(m => !m.isUser && m.label === c.key).length;
        return `
            <tr>
                <td>
                    <div class="type-col">
                        <div class="mini-icon" style="background:${c.color}">${c.icon}</div>
                        ${c.name}
                    </div>
                </td>
                <td class="val-col">${userCount}</td>
                <td class="val-col">${oppCount}</td>
            </tr>
        `;
    }).join('');

    document.getElementById('view-opening-name').innerText = activeGame.opening || 'Unknown Opening';
    const bookMoves = activeGame.moves.filter((m, i) => i < 10 && m.label === 'Best').length;
    document.getElementById('view-opening-stats').innerText = `${bookMoves} theoretical moves played`;

    document.getElementById('view-opponent').innerText = activeGame.opponent;
    document.getElementById('view-result').innerText = activeGame.result;
    document.getElementById('view-result').style.color = activeGame.result === 'Win' ? 'var(--success)' : 'var(--accent)';

    const moveCont = document.getElementById('move-list-container');
    moveCont.innerHTML = activeGame.moves.map((m, i) => `
        <div id="move-row-${i}" class="move-row" onclick="selectMove(${i})">
            <span class="move-num">${Math.floor(i/2)+1}${i%2===0 ? '.' : '...'}</span>
            <span class="move-san">${m.san} ${m.label && m.label !== 'Good' ? `<span class="badge" style="background:${CLASSIFICATIONS.find(c=>c.key===m.label).color}">${m.label}</span>`:''}</span>
            <span class="move-eval">${m.isMate ? (m.score > 0 ? 'M' : '-M')+Math.abs(m.score) : (m.score/100).toFixed(1)}</span>
        </div>
    `).join('');

    selectMove(0);
}

function exitReview() {
    activeGame = null;
    document.getElementById('game-list-view').style.display = 'block';
    document.getElementById('review-view').style.display = 'none';
}

function setTab(name) {
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${name}`).style.display = 'block';
    document.getElementById(`tab-btn-${name}`).classList.add('active');
}

function selectMove(idx) {
    currentMoveIdx = idx;
    const move = activeGame.moves[idx];
    updateBoard(move);
    updateMoveDetail(move);
    
    document.querySelectorAll('.move-row').forEach(r => r.classList.remove('active'));
    const row = document.getElementById(`move-row-${idx}`);
    if (row) {
        row.classList.add('active');
        row.scrollIntoView({ block: 'start', behavior: 'smooth' });
    }
}

function updateMoveDetail(m) {
    const pieceKey = m.color === 'w' ? m.piece.toUpperCase() : m.piece.toLowerCase();
    const pieceName = PIECE_NAMES[m.piece.toLowerCase()];
    
    document.getElementById('detail-piece-img').src = PIECES[pieceKey];
    document.getElementById('detail-name').innerText = `${pieceName} to ${m.to}`;
    document.getElementById('detail-best').innerText = `Best move: ${m.best || '-'}`;
    
    const classif = CLASSIFICATIONS.find(cl => cl.key === m.label);
    const ratingEl = document.getElementById('detail-rating');
    ratingEl.innerText = `Move Rating: ${m.label}`;
    ratingEl.style.backgroundColor = classif ? classif.color : 'transparent';
    ratingEl.style.color = 'white';
}

function stepMove(dir) {
    const next = currentMoveIdx + dir;
    if (next >= 0 && next < activeGame.moves.length) {
        selectMove(next);
    }
}

function updateBoard(m) {
    const board = document.getElementById('active-board');
    const arrows = document.getElementById('active-arrows');
    board.innerHTML = '';
    arrows.innerHTML = '';

    const rows = m.fen.split(' ')[0].split('/');
    for (let r = 0; r < 8; r++) {
        let c = 0;
        for (let char of rows[r]) {
            if (isNaN(char)) {
                createSq(board, r, c++, char, m);
            } else {
                for (let i = 0; i < parseInt(char); i++) createSq(board, r, c++, null, m);
            }
        }
    }

    if (m.best && (m.best.slice(0,2) !== m.from || m.best.slice(2,4) !== m.to)) {
        drawArrow(arrows, m.best.slice(0,2), m.best.slice(2,4));
    }

    // Evaluation Perspective: Locked to Player (Active User)
    // If user is White, score stays same. If user is Black, invert the score.
    const playerPerspectiveScore = activeGame.isWhite ? m.score : -m.score;
    const pct = m.isMate ? (playerPerspectiveScore > 0 ? 100 : 0) : (50 + (50 * Math.tanh((playerPerspectiveScore/100)/4)));
    
    document.getElementById('eval-fill').style.width = `${pct}%`;
    document.getElementById('eval-label').innerText = m.isMate ? 'M' + Math.abs(playerPerspectiveScore) : (playerPerspectiveScore/100).toFixed(1);
}

function createSq(cont, r, c, p, m) {
    const sq = document.createElement('div');
    const id = String.fromCharCode(97+c) + (8-r);
    sq.className = `square ${(r+c)%2===0 ? 'white':'black'} ${id===m.from || id===m.to ? 'highlight':''}`;
    
    if (p) {
        const img = document.createElement('img');
        img.src = PIECES[p];
        img.className = 'piece';
        sq.appendChild(img);
    }

    if (id === m.to && m.label && m.label !== 'Good') {
        const classif = CLASSIFICATIONS.find(cl => cl.key === m.label);
        if (classif) {
            const icon = document.createElement('div');
            icon.className = 'move-type-icon';
            icon.style.backgroundColor = classif.color;
            icon.innerText = classif.icon;
            sq.appendChild(icon);
        }
    }

    cont.appendChild(sq);
}

function drawArrow(svg, from, to) {
    const getC = (s) => ({ x: (s.charCodeAt(0)-97)*12.5 + 6.25, y: (8-parseInt(s[1]))*12.5 + 6.25 });
    const s = getC(from), e = getC(to);
    const angle = Math.atan2(e.y-s.y, e.x-s.x);
    const len = Math.sqrt((e.x-s.x)**2 + (e.y-s.y)**2);
    
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.setAttribute("transform", `translate(${s.x},${s.y}) rotate(${angle*180/Math.PI})`);
    
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", `M 0 0 L ${len-4} 0 M ${len-4} -3 L ${len} 0 L ${len-4} 3 Z`);
    path.setAttribute("fill", "rgba(46, 204, 113, 0.7)");
    path.setAttribute("stroke", "rgba(46, 204, 113, 0.7)");
    path.setAttribute("stroke-width", "2");
    g.appendChild(path);
    svg.appendChild(g);
}

function stopAnalysis() { isScanning = false; }
window.onload = bootEngine;
</script>
</body>
</html>

